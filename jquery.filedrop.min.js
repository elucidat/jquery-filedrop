
/* Author: Weixi Yen - Copyright (c) 2010 Resopollution - Licensed under the MIT license - http://www.github.com/weixiyen/jquery-filedrop */
(function(m){function e(){}jQuery.event.props.push("dataTransfer");var z={fallback_id:"",url:"",refresh:1E3,paramname:"userfile",allowedfiletypes:[],maxfiles:25,maxfilesize:1,queuefiles:0,queuewait:200,data:{},headers:{},drop:e,dragStart:e,dragEnter:e,dragOver:e,dragLeave:e,docEnter:e,docOver:e,docLeave:e,beforeEach:e,afterAll:e,rename:e,error:function(d){alert(d)},uploadStarted:e,uploadFinished:e,progressUpdated:e,globalProgressUpdated:e,speedUpdated:e},f="BrowserNotSupported TooManyFiles FileTooLarge FileTypeNotAllowed NotFound NotReadable AbortError ReadError".split(" "),
l,t=!1,n=0,d;m.fn.filedrop=function(e){function x(a,d,e,f){var c="";if(b.data){var j=m.param(b.data).replace(/\+/g,"%20").split(/&/);m.each(j,function(){var b=this.split("=",2),a=decodeURIComponent(b[0]),b=decodeURIComponent(b[1]);c+="--";c+=f;c+="\r\n";c+='Content-Disposition: form-data; name="'+a+'"';c+="\r\n";c+="\r\n";c+=b;c+="\r\n"})}c+="--";c+=f;c+="\r\n";c+='Content-Disposition: form-data; name="'+b.paramname+'"';c+='; filename="'+a+'"';c+="\r\n";c+="Content-Type: "+e;c+="\r\n";c+="\r\n";c+=
d;c+="\r\n";c+="--";c+=f;c+="--";return c+="\r\n"}function A(a){if(a.lengthComputable){var d=Math.round(100*a.loaded/a.total);if(this.currentProgress!==d){this.currentProgress=d;b.progressUpdated(this.index,this.file,this.currentProgress);j[this.global_progress_index]=this.currentProgress;u();var d=(new Date).getTime(),e=d-this.currentStart;e>=b.refresh&&(b.speedUpdated(this.index,this.file,(a.loaded-this.startData)/e),this.startData=a.loaded,this.currentStart=d)}}}function u(){if(0!==j.length){var a=
0,d;for(d in j)j.hasOwnProperty(d)&&(a+=j[d]);b.globalProgressUpdated(Math.round(a/j.length))}}function s(){t=!1;if(!d)return b.error(f[0]),!1;if(b.allowedfiletypes.push&&b.allowedfiletypes.length)for(var a=d.length;a--;)if(!d[a].type||0>m.inArray(d[a].type,b.allowedfiletypes))return b.error(f[3],d[a]),!1;var e=0,l=0;if(n>b.maxfiles&&0===b.queuefiles)return b.error(f[1]),!1;for(var g=[],c=[],s=[],a=0;a<n;a++)g.push(a);var p=function(){var a;if(t)return!1;if(0<b.queuefiles&&c.length>=b.queuefiles)setTimeout(p,
b.queuewait);else{a=g[0];g.splice(0,1);c.push(a);try{if(!1!==b.beforeEach(d[a])){if(a===n)return;var e=new FileReader,k=1048576*b.maxfilesize;e.index=a;if(d[a].size>k)return b.error(f[2],d[a],a),c.forEach(function(b,d){b===a&&c.splice(d,1)}),l++,!0;e.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:return b.error(f[4]),!1;case a.target.error.NOT_READABLE_ERR:return b.error(f[5]),!1;case a.target.error.ABORT_ERR:return b.error(f[6]),!1;default:return b.error(f[7]),
!1}};e.onloadend=!b.beforeSend?r:function(c){b.beforeSend(d[a],a,function(){r(c)})};e.readAsBinaryString(d[a])}else l++}catch(j){return c.forEach(function(b,d){b===a&&c.splice(d,1)}),b.error(f[0]),!1}0<g.length&&p()}},r=function(a){var f=("undefined"===typeof a.srcElement?a.target:a.srcElement).index;if(void 0===a.target.index){var k=a.target,g;a:{for(g=0;g<n;g++)if(d[g].size===a.total)break a;g=void 0}k.index=g}var h=new XMLHttpRequest,k=h.upload,q=d[a.target.index],p=a.target.index,v=(new Date).getTime();
g="------multipartformboundary"+(new Date).getTime();var w=j.length,r=b.rename(q.name),y=q.type;b.withCredentials&&(h.withCredentials=b.withCredentials);a="string"===typeof r?x(r,a.target.result,y,g):x(q.name,a.target.result,y,g);k.index=p;k.file=q;k.downloadStartTime=v;k.currentStart=v;k.currentProgress=0;k.global_progress_index=w;k.startData=0;k.addEventListener("progress",A,!1);jQuery.isFunction(b.url)?h.open("POST",b.url(),!0):h.open("POST",b.url,!0);h.setRequestHeader("content-type","multipart/form-data; boundary="+
g);m.each(b.headers,function(a,b){h.setRequestHeader(a,b)});h.sendAsBinary(a);j[w]=0;u();b.uploadStarted(p,q,n);h.onload=function(){var a=null;if(h.responseText)try{a=jQuery.parseJSON(h.responseText)}catch(d){a=h.responseText}var g=(new Date).getTime()-v,a=b.uploadFinished(p,q,a,g,h);e++;c.forEach(function(a,b){a===f&&c.splice(b,1)});s.push(f);j[w]=100;u();e===n-l&&b.afterAll();!1===a&&(t=!0);(200>h.status||299<h.status)&&b.error(h.statusText,q,f,h.status)}};p()}var b=m.extend({},z,e),j=[];this.on("drop",
function(a){if(!1===b.drop.call(this,a))return!1;d=a.dataTransfer.files;if(null===d||void 0===d||0===d.length)return b.error(f[0]),!1;n=d.length;s();a.preventDefault();return!1}).on("dragstart",b.dragStart).on("dragenter",function(a){clearTimeout(l);a.preventDefault();b.dragEnter.call(this,a)}).on("dragover",function(a){clearTimeout(l);a.preventDefault();b.docOver.call(this,a);b.dragOver.call(this,a)}).on("dragleave",function(a){clearTimeout(l);b.dragLeave.call(this,a);a.stopPropagation()});m(document).on("drop",
function(a){a.preventDefault();b.docLeave.call(this,a);return!1}).on("dragenter",function(a){clearTimeout(l);a.preventDefault();b.docEnter.call(this,a);return!1}).on("dragover",function(a){clearTimeout(l);a.preventDefault();b.docOver.call(this,a);return!1}).on("dragleave",function(a){var d=this;l=setTimeout(function(){b.docLeave.call(d,a)},200)});m("#"+b.fallback_id).change(function(a){b.drop(a);d=a.target.files;n=d.length;s()});return this};try{XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=
function(d){d=Array.prototype.map.call(d,function(d){return d.charCodeAt(0)&255});d=new Uint8Array(d);this.send(d.buffer)})}catch(B){}})(jQuery);